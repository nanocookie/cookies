<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å”è¯—å®‹è¯ Â· å¤é£é—®ç­”é—¯å…³ï¼ˆé€‰æ‹©é¢˜ & Bç«™å°ç”µè§†ï¼‰</title>
<style>
  :root{
    --bg:#f7f3ea; --ink:#2b2b2b; --primary:#8c5a2b; --accent:#b98a58;
    --jade:#2f7a69; --red:#b23a48; --gold:#d1a84a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:"LXGW WenKai Screen","STKaiti","KaiTi","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,Arial,sans-serif;
    background:
      radial-gradient(ellipse at 20% 10%, #fffdf6 0%, #f8f1e5 45%, #efe6d6 100%),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" opacity="0.08" viewBox="0 0 100 100"><text x="0" y="80" font-size="90" fill="%238c5a2b">é›²</text></svg>') repeat;
    color:var(--ink);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 60px;position:relative}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 12px}
  .seal{width:60px;height:60px;border-radius:14px;border:2px solid var(--primary);color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:2px;background:#fff3;backdrop-filter:blur(2px);box-shadow:0 2px 8px rgba(0,0,0,.08), inset 0 0 0 6px #fff}
  h1{font-size:clamp(22px,4vw,34px);margin:0;line-height:1.2;color:var(--primary);font-weight:900;letter-spacing:2px}
  .sub{color:#775;font-size:.95rem}
  .panel{background:rgba(255,255,255,.6);border:1px solid #e6d8c2;border-radius:18px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);backdrop-filter:blur(3px)}
  .grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media (min-width:960px){.grid{grid-template-columns:1.3fr .7fr}}
  .card{background:#fff;border:1px solid #eadfcf;border-radius:16px;padding:14px 16px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
  .poem-card{background:linear-gradient(180deg,#fff,#fffaf3)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #d9c8ad;background:#fff;cursor:pointer;transition:.2s;font-weight:700}
  .btn.primary{background:linear-gradient(#fef7ea,#f6e7c9);border-color:#e6d29f;color:#5e3b0a}
  .btn.ghost{background:transparent}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#efe5d1;border:1px solid #e0cda6;color:#6c5531;font-weight:700}
  .pill{padding:6px 10px;border:1px solid #e6d8c2;border-radius:999px;background:#fff}
  .muted{opacity:.8}
  .q{font-size:clamp(18px,3.2vw,26px);line-height:1.5;margin:12px 0 6px;white-space:pre-wrap}
  .lines{opacity:.9;margin:.5rem 0 .25rem}
  .opts{display:grid;gap:10px;margin-top:10px}
  .opt{border:1px solid #e6d8c2;border-radius:12px;padding:12px 14px;cursor:pointer;background:#fff;transition:.15s;position:relative}
  .opt:hover{border-color:var(--accent);box-shadow:inset 0 0 0 1px var(--accent)}
  .opt.correct{border-color:#2f7a69;background:#f0fbf7}
  .opt.wrong{border-color:#c34d53;background:#fff4f4}
  .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
  progress{width:100%;height:10px;border:0;background:#f1e6d1;border-radius:99px}
  progress::-webkit-progress-bar{background:#f1e6d1;border-radius:99px}
  progress::-webkit-progress-value{background:linear-gradient(90deg,#d7b46a,#9c6c2d);border-radius:99px}
  .timer{font-variant-numeric:tabular-nums;font-weight:900;color:var(--red);padding:6px 12px;border:1px solid #f0c5c9;background:#fff7f8;border-radius:10px}
  .hint{font-size:.95rem;color:#5a503f;background:#fffbe9;border:1px dashed #e9d9b6;border-radius:12px;padding:8px 10px;margin-top:10px}
  .right{color:var(--jade);font-weight:800}
  .wrongx{color:var(--red);font-weight:800}
  .footer{margin-top:18px;font-size:.9rem;color:#776}
  .titlebar{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .small{font-size:.92rem}
  .kanban{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .board{border:1px dashed #e0cfb3;border-radius:12px;padding:8px 10px;background:#fffef7}
  .playerBox{display:grid;gap:8px}
  .tele{display:flex;align-items:center;gap:8px}
  .tv{border:1px solid #e6d8c2;border-radius:12px;overflow:hidden;background:#000;aspect-ratio:16/9}
  .audioBadge{display:none;font-size:1rem}
</style>
</head>
<body>
  <audio id="snd-correct" preload="auto"></audio>
  <audio id="snd-wrong" preload="auto"></audio>

  <div class="wrap">
    <header>
      <div class="seal">è©©</div>
      <div>
        <h1>å”è¯—å®‹è¯ Â· é—®ç­”é—¯å…³</h1>
        <div class="sub">äºŒåé¢˜ä¸€è½®ï½œé€‰æ‹©é¢˜ï½œæ¯é¢˜ 20 ç§’ï½œé”™é¢˜æœ¬ä¸å°ç”µè§†</div>
      </div>
    </header>

    <div class="grid">
      <main class="panel">
        <div class="titlebar">
          <div class="controls">
            <span class="badge">ç¬¬ <b id="roundNo">1</b> è½®</span>
            <span class="pill">ç›®æ ‡ï¼š<b>20</b> é¢˜</span>
            <span class="pill">æ€»é¢˜åº“ï¼š<b id="poolSize">â€”</b></span>
          </div>
          <div class="controls">
            <button class="btn primary" id="btnStart">å¼€å§‹é—¯å…³</button>
            <button class="btn" id="btnAgain" style="display:none">å†æ¥ä¸€è½®</button>
          </div>
        </div>

        <div class="card poem-card" id="qaBox" style="display:none">
          <div class="meta">
            <span class="badge">é¢˜ç›® <b id="qIndex">1</b> / <b id="qTotal">20</b></span>
            <span class="badge">éš¾åº¦ï¼š<b id="qDiff">å…¥é—¨</b></span>
            <span class="timer">â³ <span id="timeLeft">20</span>s</span>
          </div>
          <div class="q" id="questionText">é¢˜ç›®åŠ è½½ä¸­â€¦</div>
          <div class="lines small muted" id="extra"></div>
          <div id="options" class="opts"></div>
          <div class="hint" id="hint" style="display:none"></div>
          <div class="meta">
            <progress id="prog" max="20" value="0"></progress>
            <span class="pill">å¾—åˆ†ï¼š<b id="score">0</b></span>
          </div>
        </div>

        <section class="card" id="summary" style="display:none">
          <h3>æœ¬è½®æ€»ç»“</h3>
          <div id="sumText"></div>
          <div class="controls" style="margin-top:8px">
            <button class="btn primary" id="btnRetry">å†æˆ˜ä¸€è½®</button>
            <button class="btn" id="btnReview">æŸ¥çœ‹é”™é¢˜æœ¬</button>
            <button class="btn ghost" id="btnClearWrong">æ¸…ç©ºé”™é¢˜æœ¬</button>
          </div>
        </section>

        <section class="card" id="review" style="display:none">
          <div class="titlebar">
            <h3>é”™é¢˜æœ¬</h3>
            <button class="btn" id="btnCloseReview">å…³é—­</button>
          </div>
          <div id="wrongList" class="kanban"></div>
        </section>

        <div class="footer">æç¤ºï¼šæŒ‰ <b>1-4</b> ä¹Ÿå¯å¿«é€Ÿä½œç­”ï¼›æ¯é¢˜å›ºå®š <b>20s</b>ï¼Œå…¨éƒ¨ä¸ºé€‰æ‹©é¢˜ã€‚</div>
      </main>

      <aside class="panel">
        <h3>å°ç”µè§† Â· B ç«™æ’­æ”¾å™¨</h3>
        <div class="card playerBox">
          <div class="tele">
            <input id="mediaInput" class="small" style="flex:1;padding:8px;border:1px solid #e2d6c1;border-radius:10px" placeholder="BV1afgjzVEUG"/>
            <button class="btn" id="btnLoadUrl">æ’­æ”¾</button>
          </div>
          <div class="tele">
            <input type="file" id="filePicker" accept="video/*,audio/*"/>
            <button class="btn" id="btnLoadLocal">æ’­æ”¾æœ¬åœ°</button>
            <span id="audioEmoji" class="audioBadge">ğŸµ éŸ³é¢‘æ’­æ”¾ä¸­</span>
          </div>
          <div class="small muted">
            ç¤ºä¾‹ï¼šBV1xx411c7mD æˆ– https://www.bilibili.com/video/BV1xx411c7mD  
            ä¹Ÿå¯å¡«ä»»æ„ mp4/mp3/flac/ogg ç­‰ç›´é“¾ï¼›æˆ–é€‰æ‹©æœ¬åœ°æ–‡ä»¶ã€‚
          </div>
          <div id="playerMount" class="tv"></div>
        </div>

        <div class="card">
          <h4>æ’è¡Œæ¦œï¼ˆæœ¬æœºï¼‰</h4>
          <ol id="rank" class="small" style="margin:0;padding-left:1.1rem"></ol>
          <div class="controls">
            <button class="btn" id="btnSaveRank">ä¿å­˜æœ¬è½®æˆç»©</button>
            <button class="btn ghost" id="btnClearRank">æ¸…ç©º</button>
          </div>
        </div>

        <div class="card">
          <h4>å…³äºé¢˜åº“ä¸éš¾åº¦</h4>
          <div class="small">
            é¢˜åº“å« 60+ é¦–å”å®‹åç¯‡å¹¶æ ‡æ³¨ <b>å†…å®¹éš¾åº¦ 1-3</b>ï¼š1=å¹¿ä¸ºäººçŸ¥ï¼Œ3=ç›¸å¯¹å†·é—¨æˆ–å¥å¼æ›´éš¾ã€‚æ¯è½®è‡ªåŠ¨ç¼–æ’ 6/8/6ï¼ˆæ˜“/ä¸­/éš¾ï¼‰ï¼Œæ€»è®¡è‡ªåŠ¨ç»„åˆ â‰¥300 é“é¢˜ã€‚
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ========= å¯¹é”™éŸ³æ•ˆï¼ˆæç®€ Base64 ç¤ºä¾‹ï¼Œå¯è‡ªè¡Œæ›¿æ¢ï¼‰ ========= */
const SND_CORRECT = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA...";
const SND_WRONG   = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA...";
const sndOk = document.getElementById('snd-correct');
const sndNg = document.getElementById('snd-wrong');
sndOk.src = SND_CORRECT; sndNg.src = SND_WRONG;
function playOk(){ try{sndOk.currentTime=0; sndOk.play();}catch{} }
function playNg(){ try{sndNg.currentTime=0; sndNg.play();}catch{} }

/* ========= è¯—è¯æ•°æ®ï¼ˆå«å†…å®¹éš¾åº¦ level:1/2/3ï¼‰ ========= */
const POEMS = [
  // level=1ï¼ˆå¹¿ä¸ºäººçŸ¥ï¼‰
  {title:"é™å¤œæ€", author:"æç™½", dynasty:"å”", level:1, lines:["åºŠå‰æ˜æœˆå…‰","ç–‘æ˜¯åœ°ä¸Šéœœ","ä¸¾å¤´æœ›æ˜æœˆ","ä½å¤´æ€æ•…ä¹¡"]},
  {title:"æ˜¥æ™“", author:"å­Ÿæµ©ç„¶", dynasty:"å”", level:1, lines:["æ˜¥çœ ä¸è§‰æ™“","å¤„å¤„é—»å•¼é¸Ÿ","å¤œæ¥é£é›¨å£°","èŠ±è½çŸ¥å¤šå°‘"]},
  {title:"ç™»é¹³é›€æ¥¼", author:"ç‹ä¹‹æ¶£", dynasty:"å”", level:1, lines:["ç™½æ—¥ä¾å±±å°½","é»„æ²³å…¥æµ·æµ","æ¬²ç©·åƒé‡Œç›®","æ›´ä¸Šä¸€å±‚æ¥¼"]},
  {title:"æœ›åºå±±ç€‘å¸ƒ", author:"æç™½", dynasty:"å”", level:1, lines:["æ—¥ç…§é¦™ç‚‰ç”Ÿç´«çƒŸ","é¥çœ‹ç€‘å¸ƒæŒ‚å‰å·","é£æµç›´ä¸‹ä¸‰åƒå°º","ç–‘æ˜¯é“¶æ²³è½ä¹å¤©"]},
  {title:"é»„é¹¤æ¥¼é€å­Ÿæµ©ç„¶ä¹‹å¹¿é™µ", author:"æç™½", dynasty:"å”", level:1, lines:["æ•…äººè¥¿è¾é»„é¹¤æ¥¼","çƒŸèŠ±ä¸‰æœˆä¸‹æ‰¬å·","å­¤å¸†è¿œå½±ç¢§ç©ºå°½","å”¯è§é•¿æ±Ÿå¤©é™…æµ"]},
  {title:"é€å…ƒäºŒä½¿å®‰è¥¿ï¼ˆæ¸­åŸæ›²ï¼‰", author:"ç‹ç»´", dynasty:"å”", level:1, lines:["æ¸­åŸæœé›¨æµ¥è½»å°˜","å®¢èˆé’é’æŸ³è‰²æ–°","åŠå›æ›´å°½ä¸€æ¯é…’","è¥¿å‡ºé˜³å…³æ— æ•…äºº"]},
  {title:"æ¸…æ˜", author:"æœç‰§", dynasty:"å”", level:1, lines:["æ¸…æ˜æ—¶èŠ‚é›¨çº·çº·","è·¯ä¸Šè¡Œäººæ¬²æ–­é­‚","å€Ÿé—®é…’å®¶ä½•å¤„æœ‰","ç‰§ç«¥é¥æŒ‡æèŠ±æ‘"]},
  {title:"æ±Ÿé›ª", author:"æŸ³å®—å…ƒ", dynasty:"å”", level:1, lines:["åƒå±±é¸Ÿé£ç»","ä¸‡å¾„äººè¸ªç­","å­¤èˆŸè“‘ç¬ ç¿","ç‹¬é’“å¯’æ±Ÿé›ª"]},
  {title:"ç›¸æ€", author:"ç‹ç»´", dynasty:"å”", level:1, lines:["çº¢è±†ç”Ÿå—å›½","æ˜¥æ¥å‘å‡ æ","æ„¿å›å¤šé‡‡æ’·","æ­¤ç‰©æœ€ç›¸æ€"]},
  {title:"å›ä¹¡å¶ä¹¦ï¼ˆä¸€ï¼‰", author:"è´ºçŸ¥ç« ", dynasty:"å”", level:1, lines:["å°‘å°ç¦»å®¶è€å¤§å›","ä¹¡éŸ³æ— æ”¹é¬“æ¯›è¡°","å„¿ç«¥ç›¸è§ä¸ç›¸è¯†","ç¬‘é—®å®¢ä»ä½•å¤„æ¥"]},
  {title:"é¢˜è¥¿æ—å£", author:"è‹è½¼", dynasty:"å®‹", level:1, lines:["æ¨ªçœ‹æˆå²­ä¾§æˆå³°","è¿œè¿‘é«˜ä½å„ä¸åŒ","ä¸è¯†åºå±±çœŸé¢ç›®","åªç¼˜èº«åœ¨æ­¤å±±ä¸­"]},
  {title:"é¥®æ¹–ä¸Šåˆæ™´åé›¨", author:"è‹è½¼", dynasty:"å®‹", level:1, lines:["æ°´å…‰æ½‹æ»Ÿæ™´æ–¹å¥½","å±±è‰²ç©ºè’™é›¨äº¦å¥‡","æ¬²æŠŠè¥¿æ¹–æ¯”è¥¿å­","æ·¡å¦†æµ“æŠ¹æ€»ç›¸å®œ"]},
  {title:"æ°´è°ƒæ­Œå¤´ï¼ˆæ˜æœˆå‡ æ—¶æœ‰ï¼‰", author:"è‹è½¼", dynasty:"å®‹", level:1, lines:["æ˜æœˆå‡ æ—¶æœ‰","æŠŠé…’é—®é’å¤©","ä¸çŸ¥å¤©ä¸Šå®«é˜™","ä»Šå¤•æ˜¯ä½•å¹´"]},
  {title:"å¦‚æ¢¦ä»¤ï¼ˆå¸¸è®°æºªäº­æ—¥æš®ï¼‰", author:"ææ¸…ç…§", dynasty:"å®‹", level:1, lines:["å¸¸è®°æºªäº­æ—¥æš®","æ²‰é†‰ä¸çŸ¥å½’è·¯","å…´å°½æ™šå›èˆŸ","è¯¯å…¥è—•èŠ±æ·±å¤„"]},
  {title:"æ˜¥æ—¥", author:"æœ±ç†¹", dynasty:"å®‹", level:1, lines:["èƒœæ—¥å¯»èŠ³æ³—æ°´æ»¨","æ— è¾¹å…‰æ™¯ä¸€æ—¶æ–°","ç­‰é—²è¯†å¾—ä¸œé£é¢","ä¸‡ç´«åƒçº¢æ€»æ˜¯æ˜¥"]},
  {title:"æ¸¸å±±è¥¿æ‘", author:"é™†æ¸¸", dynasty:"å®‹", level:1, lines:["è«ç¬‘å†œå®¶è…Šé…’æµ‘","ä¸°å¹´ç•™å®¢è¶³é¸¡è±š","å±±é‡æ°´å¤ç–‘æ— è·¯","æŸ³æš—èŠ±æ˜åˆä¸€æ‘"]},
  {title:"ç™»é«˜ï¼ˆèŠ‚é€‰ï¼‰", author:"æœç”«", dynasty:"å”", level:1, lines:["æ— è¾¹è½æœ¨è§è§ä¸‹","ä¸å°½é•¿æ±Ÿæ»šæ»šæ¥"]},

  // level=2ï¼ˆè¾ƒç†Ÿä½†ä¸ä¸€å®šäººäººèƒ½èƒŒå…¨ï¼‰
  {title:"æ—©å‘ç™½å¸åŸ", author:"æç™½", dynasty:"å”", level:2, lines:["æœè¾ç™½å¸å½©äº‘é—´","åƒé‡Œæ±Ÿé™µä¸€æ—¥è¿˜","ä¸¤å²¸çŒ¿å£°å•¼ä¸ä½","è½»èˆŸå·²è¿‡ä¸‡é‡å±±"]},
  {title:"ä¹æœˆä¹æ—¥å¿†å±±ä¸œå…„å¼Ÿ", author:"ç‹ç»´", dynasty:"å”", level:2, lines:["ç‹¬åœ¨å¼‚ä¹¡ä¸ºå¼‚å®¢","æ¯é€¢ä½³èŠ‚å€æ€äº²","é¥çŸ¥å…„å¼Ÿç™»é«˜å¤„","éæ’èŒ±è¸å°‘ä¸€äºº"]},
  {title:"å‡ºå¡", author:"ç‹æ˜Œé¾„", dynasty:"å”", level:2, lines:["ç§¦æ—¶æ˜æœˆæ±‰æ—¶å…³","ä¸‡é‡Œé•¿å¾äººæœªè¿˜","ä½†ä½¿é¾™åŸé£å°†åœ¨","ä¸æ•™èƒ¡é©¬åº¦é˜´å±±"]},
  {title:"èŠ™è“‰æ¥¼é€è¾›æ¸", author:"ç‹æ˜Œé¾„", dynasty:"å”", level:2, lines:["å¯’é›¨è¿æ±Ÿå¤œå…¥å´","å¹³æ˜é€å®¢æ¥šå±±å­¤","æ´›é˜³äº²å‹å¦‚ç›¸é—®","ä¸€ç‰‡å†°å¿ƒåœ¨ç‰å£¶"]},
  {title:"é»„é¹¤æ¥¼", author:"å´”é¢¢", dynasty:"å”", level:2, lines:["æ˜”äººå·²ä¹˜é»„é¹¤å»","æ­¤åœ°ç©ºä½™é»„é¹¤æ¥¼","é»„é¹¤ä¸€å»ä¸å¤è¿”","ç™½äº‘åƒè½½ç©ºæ‚ æ‚ "]},
  {title:"æ«æ¡¥å¤œæ³Š", author:"å¼ ç»§", dynasty:"å”", level:2, lines:["æœˆè½ä¹Œå•¼éœœæ»¡å¤©","æ±Ÿæ«æ¸”ç«å¯¹æ„çœ ","å§‘è‹åŸå¤–å¯’å±±å¯º","å¤œåŠé’Ÿå£°åˆ°å®¢èˆ¹"]},
  {title:"æ³Šç§¦æ·®", author:"æœç‰§", dynasty:"å”", level:2, lines:["çƒŸç¬¼å¯’æ°´æœˆç¬¼æ²™","å¤œæ³Šç§¦æ·®è¿‘é…’å®¶","å•†å¥³ä¸çŸ¥äº¡å›½æ¨","éš”æ±ŸçŠ¹å”±ååº­èŠ±"]},
  {title:"èµ¤å£", author:"æœç‰§", dynasty:"å”", level:2, lines:["æŠ˜æˆŸæ²‰æ²™é“æœªé”€","è‡ªå°†ç£¨æ´—è®¤å‰æœ","ä¸œé£ä¸ä¸å‘¨éƒä¾¿","é“œé›€æ˜¥æ·±é”äºŒä¹”"]},
  {title:"å¤œé›¨å¯„åŒ—", author:"æå•†éš", dynasty:"å”", level:2, lines:["å›é—®å½’æœŸæœªæœ‰æœŸ","å·´å±±å¤œé›¨æ¶¨ç§‹æ± ","ä½•å½“å…±å‰ªè¥¿çª—çƒ›","å´è¯å·´å±±å¤œé›¨æ—¶"]},
  {title:"ç»å¥ï¼ˆäºŒï¼‰", author:"æœç”«", dynasty:"å”", level:2, lines:["ä¸¤ä¸ªé»„é¹‚é¸£ç¿ æŸ³","ä¸€è¡Œç™½é¹­ä¸Šé’å¤©","çª—å«è¥¿å²­åƒç§‹é›ª","é—¨æ³Šä¸œå´ä¸‡é‡Œèˆ¹"]},
  {title:"é—»å®˜å†›æ”¶æ²³å—æ²³åŒ—", author:"æœç”«", dynasty:"å”", level:2, lines:["å‰‘å¤–å¿½ä¼ æ”¶è“ŸåŒ—","åˆé—»æ¶•æ³ªæ»¡è¡£è£³","å´çœ‹å¦»å­æ„ä½•åœ¨","æ¼«å·è¯—ä¹¦å–œæ¬²ç‹‚"]},
  {title:"è§‚ä¹¦æœ‰æ„Ÿï¼ˆå…¶ä¸€ï¼‰", author:"æœ±ç†¹", dynasty:"å®‹", level:2, lines:["åŠäº©æ–¹å¡˜ä¸€é‰´å¼€","å¤©å…‰äº‘å½±å…±å¾˜å¾Š","é—®æ¸ å“ªå¾—æ¸…å¦‚è®¸","ä¸ºæœ‰æºå¤´æ´»æ°´æ¥"]},
  {title:"æ¸…å¹³ä¹Â·æ‘å±…", author:"è¾›å¼ƒç–¾", dynasty:"å®‹", level:2, lines:["èŒ…æªä½å°","æºªä¸Šé’é’è‰","é†‰é‡Œå´éŸ³ç›¸åªšå¥½","ç™½å‘è°å®¶ç¿åªª"]},
  {title:"è¥¿æ±ŸæœˆÂ·å¤œè¡Œé»„æ²™é“ä¸­", author:"è¾›å¼ƒç–¾", dynasty:"å®‹", level:2, lines:["æ˜æœˆåˆ«ææƒŠé¹Š","æ¸…é£åŠå¤œé¸£è‰","ç¨»èŠ±é¦™é‡Œè¯´ä¸°å¹´","å¬å–è›™å£°ä¸€ç‰‡"]},
  {title:"åœç®—å­Â·å’æ¢…", author:"é™†æ¸¸", dynasty:"å®‹", level:2, lines:["é©¿å¤–æ–­æ¡¥è¾¹","å¯‚å¯å¼€æ— ä¸»","å·²æ˜¯é»„æ˜ç‹¬è‡ªæ„","æ›´è‘—é£å’Œé›¨"]},
  {title:"å¿†æ±Ÿå—", author:"ç™½å±…æ˜“", dynasty:"å”", level:2, lines:["æ±Ÿå—å¥½","é£æ™¯æ—§æ›¾è°™","æ—¥å‡ºæ±ŸèŠ±çº¢èƒœç«","æ˜¥æ¥æ±Ÿæ°´ç»¿å¦‚è“"]},
  {title:"é¢˜éƒ½åŸå—åº„", author:"å´”æŠ¤", dynasty:"å”", level:2, lines:["å»å¹´ä»Šæ—¥æ­¤é—¨ä¸­","äººé¢æ¡ƒèŠ±ç›¸æ˜ çº¢","äººé¢ä¸çŸ¥ä½•å¤„å»","æ¡ƒèŠ±ä¾æ—§ç¬‘æ˜¥é£"]},

  // level=3ï¼ˆç›¸å¯¹éš¾ï¼‰
  {title:"å±±å±…ç§‹æš", author:"ç‹ç»´", dynasty:"å”", level:3, lines:["ç©ºå±±æ–°é›¨å","å¤©æ°”æ™šæ¥ç§‹","æ˜æœˆæ¾é—´ç…§","æ¸…æ³‰çŸ³ä¸Šæµ"]},
  {title:"é¹¿æŸ´", author:"ç‹ç»´", dynasty:"å”", level:3, lines:["ç©ºå±±ä¸è§äºº","ä½†é—»äººè¯­å“","è¿”æ™¯å…¥æ·±æ—","å¤ç…§é’è‹”ä¸Š"]},
  {title:"èµ‹å¾—å¤åŸè‰é€åˆ«", author:"ç™½å±…æ˜“", dynasty:"å”", level:3, lines:["ç¦»ç¦»åŸä¸Šè‰","ä¸€å²ä¸€æ¯è£","é‡ç«çƒ§ä¸å°½","æ˜¥é£å¹åˆç”Ÿ"]},
  {title:"é’±å¡˜æ¹–æ˜¥è¡Œ", author:"ç™½å±…æ˜“", dynasty:"å”", level:3, lines:["å­¤å±±å¯ºåŒ—è´¾äº­è¥¿","æ°´é¢åˆå¹³äº‘è„šä½","å‡ å¤„æ—©èºäº‰æš–æ ‘","è°å®¶æ–°ç‡•å•„æ˜¥æ³¥"]},
  {title:"æ— é¢˜ï¼ˆç›¸è§æ—¶éš¾ï¼‰", author:"æå•†éš", dynasty:"å”", level:3, lines:["ç›¸è§æ—¶éš¾åˆ«äº¦éš¾","ä¸œé£æ— åŠ›ç™¾èŠ±æ®‹","æ˜¥èš•åˆ°æ­»ä¸æ–¹å°½","èœ¡ç‚¬æˆç°æ³ªå§‹å¹²"]},
  {title:"æœ›å²³", author:"æœç”«", dynasty:"å”", level:3, lines:["å²±å®—å¤«å¦‚ä½•","é½é²é’æœªäº†","é€ åŒ–é’Ÿç¥ç§€","é˜´é˜³å‰²æ˜æ™“"]},
  {title:"æ—…å¤œä¹¦æ€€", author:"æœç”«", dynasty:"å”", level:3, lines:["ç»†è‰å¾®é£å²¸","å±æ¨¯ç‹¬å¤œèˆŸ","æ˜Ÿå‚å¹³é‡é˜”","æœˆæ¶Œå¤§æ±Ÿæµ"]},
  {title:"æ¸¸å­åŸ", author:"å­ŸéƒŠ", dynasty:"å”", level:3, lines:["æ…ˆæ¯æ‰‹ä¸­çº¿","æ¸¸å­èº«ä¸Šè¡£","ä¸´è¡Œå¯†å¯†ç¼","æ„æè¿Ÿè¿Ÿå½’"]},
  {title:"æ—©æ˜¥å‘ˆæ°´éƒ¨å¼ åå…«å‘˜å¤–", author:"éŸ©æ„ˆ", dynasty:"å”", level:3, lines:["å¤©è¡—å°é›¨æ¶¦å¦‚é…¥","è‰è‰²é¥çœ‹è¿‘å´æ— ","æœ€æ˜¯ä¸€å¹´æ˜¥å¥½å¤„","ç»èƒœçƒŸæŸ³æ»¡çš‡éƒ½"]},
  {title:"å’æŸ³", author:"è´ºçŸ¥ç« ", dynasty:"å”", level:3, lines:["ç¢§ç‰å¦†æˆä¸€æ ‘é«˜","ä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦","ä¸çŸ¥ç»†å¶è°è£å‡º","äºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€"]},
  {title:"å¯»éšè€…ä¸é‡", author:"è´¾å²›", dynasty:"å”", level:3, lines:["æ¾ä¸‹é—®ç«¥å­","è¨€å¸ˆé‡‡è¯å»","åªåœ¨æ­¤å±±ä¸­","äº‘æ·±ä¸çŸ¥å¤„"]},
  {title:"å®šé£æ³¢ï¼ˆè«å¬ç©¿æ—æ‰“å¶å£°ï¼‰", author:"è‹è½¼", dynasty:"å®‹", level:3, lines:["è«å¬ç©¿æ—æ‰“å¶å£°","ä½•å¦¨åŸå•¸ä¸”å¾è¡Œ","ç«¹æ–èŠ’é‹è½»èƒœé©¬","è°æ€•ï¼Ÿä¸€è“‘çƒŸé›¨ä»»å¹³ç”Ÿ"]},
  {title:"æ±ŸåŸå­Â·å¯†å·å‡ºçŒ", author:"è‹è½¼", dynasty:"å®‹", level:3, lines:["è€å¤«èŠå‘å°‘å¹´ç‹‚","å·¦ç‰µé»„å³æ“è‹","é”¦å¸½è²‚è£˜","åƒéª‘å·å¹³å†ˆ"]},
  {title:"å¿µå¥´å¨‡Â·èµ¤å£æ€€å¤", author:"è‹è½¼", dynasty:"å®‹", level:3, lines:["å¤§æ±Ÿä¸œå»","æµªæ·˜å°½ï¼Œåƒå¤é£æµäººç‰©","æ•…å’è¥¿è¾¹","äººé“æ˜¯ã€ä¸‰å›½å‘¨éƒèµ¤å£"]},
  {title:"è¶æ‹èŠ±ï¼ˆæ˜¥æ™¯ï¼‰", author:"è‹è½¼", dynasty:"å®‹", level:3, lines:["èŠ±è¤ªæ®‹çº¢é’æå°","ç‡•å­é£æ—¶ï¼Œç»¿æ°´äººå®¶ç»•","æä¸ŠæŸ³ç»µå¹åˆå°‘","å¤©æ¶¯ä½•å¤„æ— èŠ³è‰"]},
  {title:"æµ£æºªæ²™ï¼ˆä¸€æ›²æ–°è¯é…’ä¸€æ¯ï¼‰", author:"æ™æ®Š", dynasty:"å®‹", level:3, lines:["ä¸€æ›²æ–°è¯é…’ä¸€æ¯","å»å¹´å¤©æ°”æ—§äº­å°","å¤•é˜³è¥¿ä¸‹å‡ æ—¶å›"]},
  {title:"è¶æ‹èŠ±ï¼ˆæ— å¯å¥ˆä½•èŠ±è½å»ï¼‰", author:"æ™æ®Š", dynasty:"å®‹", level:3, lines:["æ— å¯å¥ˆä½•èŠ±è½å»","ä¼¼æ›¾ç›¸è¯†ç‡•å½’æ¥","å°å›­é¦™å¾„ç‹¬å¾˜å¾Š"]},
  {title:"æ¸”å®¶å‚²Â·ç§‹æ€", author:"èŒƒä»²æ·¹", dynasty:"å®‹", level:3, lines:["å¡ä¸‹ç§‹æ¥é£æ™¯å¼‚","è¡¡é˜³é›å»æ— ç•™æ„","å››é¢è¾¹å£°è¿è§’èµ·","åƒå¶‚é‡Œï¼Œé•¿çƒŸè½æ—¥å­¤åŸé—­"]},
  {title:"é’ç‰æ¡ˆÂ·å…ƒå¤•", author:"è¾›å¼ƒç–¾", dynasty:"å®‹", level:3, lines:["ä¸œé£å¤œæ”¾èŠ±åƒæ ‘","æ›´å¹è½ã€æ˜Ÿå¦‚é›¨","å®é©¬é›•è½¦é¦™æ»¡è·¯","å‡¤ç®«å£°åŠ¨ï¼Œç‰å£¶å…‰è½¬"]},
  {title:"è©è¨è›®Â·ä¹¦æ±Ÿè¥¿é€ å£å£", author:"è¾›å¼ƒç–¾", dynasty:"å®‹", level:3, lines:["éƒå­¤å°ä¸‹æ¸…æ±Ÿæ°´","ä¸­é—´å¤šå°‘è¡Œäººæ³ª","è¥¿åŒ—æœ›é•¿å®‰","å¯æ€œæ— æ•°å±±"]},
  {title:"æ­¦é™µæ˜¥ï¼ˆé£ä½å°˜é¦™èŠ±å·²å°½ï¼‰", author:"ææ¸…ç…§", dynasty:"å®‹", level:3, lines:["é£ä½å°˜é¦™èŠ±å·²å°½","æ—¥æ™šå€¦æ¢³å¤´","ç‰©æ˜¯äººéäº‹äº‹ä¼‘","æ¬²è¯­æ³ªå…ˆæµ"]},
  {title:"å£°å£°æ…¢ï¼ˆå¯»å¯»è§…è§…ï¼‰", author:"ææ¸…ç…§", dynasty:"å®‹", level:3, lines:["å¯»å¯»è§…è§…","å†·å†·æ¸…æ¸…","å‡„å‡„æƒ¨æƒ¨æˆšæˆš","ä¹æš–è¿˜å¯’æ—¶å€™"]},
  {title:"é’—å¤´å‡¤ï¼ˆçº¢é…¥æ‰‹ï¼‰", author:"é™†æ¸¸", dynasty:"å®‹", level:3, lines:["çº¢é…¥æ‰‹","é»„æ»•é…’","æ»¡åŸæ˜¥è‰²å®«å¢™æŸ³","ä¸œé£æ¶ï¼Œæ¬¢æƒ…è–„","ä¸€æ€€æ„ç»ªï¼Œå‡ å¹´ç¦»ç´¢"]},
  {title:"ç¤ºå„¿", author:"é™†æ¸¸", dynasty:"å®‹", level:3, lines:["æ­»å»å…ƒçŸ¥ä¸‡äº‹ç©º","ä½†æ‚²ä¸è§ä¹å·åŒ","ç‹å¸ˆåŒ—å®šä¸­åŸæ—¥","å®¶ç¥­æ— å¿˜å‘Šä¹ƒç¿"]},
  {title:"é¢˜ä¸´å®‰é‚¸", author:"æ—å‡", dynasty:"å®‹", level:3, lines:["å±±å¤–é’å±±æ¥¼å¤–æ¥¼","è¥¿æ¹–æ­Œèˆå‡ æ—¶ä¼‘","æš–é£ç†å¾—æ¸¸äººé†‰","ç›´æŠŠæ­å·ä½œæ±´å·"]},
  {title:"é›¨éœ–é“ƒï¼ˆå¯’è‰å‡„åˆ‡ï¼‰", author:"æŸ³æ°¸", dynasty:"åŒ—å®‹", level:3, lines:["å¯’è‰å‡„åˆ‡","å¯¹é•¿äº­æ™š","éª¤é›¨åˆæ­‡","éƒ½é—¨å¸é¥®æ— ç»ª"]},
  {title:"æœ›æµ·æ½®ï¼ˆä¸œå—å½¢èƒœï¼‰", author:"æŸ³æ°¸", dynasty:"åŒ—å®‹", level:3, lines:["ä¸œå—å½¢èƒœ","ä¸‰å´éƒ½ä¼š","é’±å¡˜è‡ªå¤ç¹å","çƒŸæŸ³ç”»æ¡¥","é£å¸˜ç¿ å¹•"]},
  {title:"åœç®—å­ï¼ˆæˆ‘ä½é•¿æ±Ÿå¤´ï¼‰", author:"æä¹‹ä»ª", dynasty:"åŒ—å®‹", level:3, lines:["æˆ‘ä½é•¿æ±Ÿå¤´","å›ä½é•¿æ±Ÿå°¾","æ—¥æ—¥æ€å›ä¸è§å›","å…±é¥®é•¿æ±Ÿæ°´"]},
  {title:"å¤œä¸Šå—é™åŸé—»ç¬›", author:"æç›Š", dynasty:"å”", level:3, lines:["å›ä¹å³°å‰æ²™ä¼¼é›ª","å—é™åŸå¤–æœˆå¦‚éœœ","ä¸çŸ¥ä½•å¤„å¹èŠ¦ç®¡","ä¸€å¤œå¾äººå°½æœ›ä¹¡"]},
  {title:"æœ›å¤©é—¨å±±", author:"æç™½", dynasty:"å”", level:3, lines:["å¤©é—¨ä¸­æ–­æ¥šæ±Ÿå¼€","ç¢§æ°´ä¸œæµè‡³æ­¤å›","ä¸¤å²¸é’å±±ç›¸å¯¹å‡º","å­¤å¸†ä¸€ç‰‡æ—¥è¾¹æ¥"]}
];
// 65+ é¦–ï¼›æ¯é¦–æ´¾ç”Ÿ 4~6 é“é€‰æ‹©é¢˜ï¼Œåˆè®¡ â‰¥300 é¢˜

/* ========= å·¥å…· ========= */
function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* ========= å‡ºé¢˜ï¼ˆå…¨éƒ¨é€‰æ‹©é¢˜ï¼‰ ========= */
const DIFF_LABEL = {1:"å…¥é—¨",2:"è¿›é˜¶",3:"æŒ‘æˆ˜"};
const PER_ROUND = {1:6, 2:8, 3:6}; // æ˜“/ä¸­/éš¾ å„å‡ºé¢˜é‡
const FIX_TIME = 20;

function genQuestions(){
  const items=[];
  [1,2,3].forEach(level=>{
    const pool = POEMS.filter(p=>p.level===level);
    for(let i=0;i<PER_ROUND[level];i++){
      const poem = pick(pool);
      const types = ["nextLineMC","prevLineMC","authorMC","titleMC"];
      const type = pick(types);
      items.push(makeMC(poem,type, level));
    }
  });
  return shuffle(items); // æ‰“ä¹±é¡ºåº
}

function makeMC(poem,type, level){
  const lines = poem.lines;
  const qi = Math.floor(Math.random()*lines.length);
  let stem="", extra="", opts=null, answer="";
  const authors = shuffle(POEMS.map(p=>p.author).filter((v,i,a)=>a.indexOf(v)===i && v!==poem.author)).slice(0,3);
  const titles = shuffle(POEMS.map(p=>p.title).filter(t=>t!==poem.title)).slice(0,3);

  switch(type){
    case "nextLineMC":{
      const i = Math.min(qi, lines.length-2);
      stem = `ã€ä¸‹å¥æ˜¯å“ªä¸€å¥ï¼Ÿã€‘\n${lines[i]}`;
      answer = lines[i+1];
      const wrongs = shuffle(POEMS.map(p=>pick(p.lines))).filter(l=>l!==answer).slice(0,3);
      opts = shuffle([answer, ...wrongs]);
      extra = `å‡ºè‡ªã€Š${poem.title}ã€‹Â·${poem.author}ï¼ˆ${poem.dynasty}ï¼‰`;
      break;
    }
    case "prevLineMC":{
      const i = Math.max(1, qi);
      stem = `ã€ä¸Šå¥æ˜¯å“ªä¸€å¥ï¼Ÿã€‘\n${lines[i]}`;
      answer = lines[i-1];
      const wrongs = shuffle(POEMS.map(p=>pick(p.lines))).filter(l=>l!==answer).slice(0,3);
      opts = shuffle([answer, ...wrongs]);
      extra = `å‡ºè‡ªã€Š${poem.title}ã€‹Â·${poem.author}ï¼ˆ${poem.dynasty}ï¼‰`;
      break;
    }
    case "authorMC":{
      stem = `ã€ä½œè€…æ˜¯è°ï¼Ÿã€‘\nã€Š${poem.title}ã€‹ï¼š${pick(lines)}`;
      answer = poem.author;
      opts = shuffle([answer, ...authors]);
      extra = `æœä»£ï¼š${poem.dynasty}`;
      break;
    }
    case "titleMC":{
      stem = `ã€é¢˜ç›®æ˜¯å“ªä¸€ç¯‡ï¼Ÿã€‘\n${pick(lines)} / ${pick(lines)}`;
      answer = poem.title;
      opts = shuffle([answer, ...titles]);
      extra = `ä½œè€…ï¼š${poem.author}ï¼ˆ${poem.dynasty}ï¼‰`;
      break;
    }
  }
  return {poem, stem, extra, opts, answer, level, time:FIX_TIME};
}

/* ========= æ¸¸æˆä¸»é€»è¾‘ ========= */
const $ = s=>document.querySelector(s);
const qaBox = $('#qaBox'), qText=$('#questionText'), extra=$('#extra'), optsBox=$('#options');
const prog=$('#prog'), qIndex=$('#qIndex'), qTotal=$('#qTotal'), qDiff=$('#qDiff'), timeLeft=$('#timeLeft'), scoreEl=$('#score'), sumBox=$('#summary'), sumText=$('#sumText');
const wrongList=$('#wrongList');
const btnStart=$('#btnStart'), btnAgain=$('#btnAgain'), btnRetry=$('#btnRetry');
const btnReview=$('#btnReview'), btnCloseReview=$('#btnCloseReview'), btnClearWrong=$('#btnClearWrong');
const roundNo=$('#roundNo'), poolSize=$('#poolSize');

let state = {
  round:1, total:20, idx:0, score:0, timer:null, tLeft:0, items:[], wrong: JSON.parse(localStorage.getItem('poem_wrong')||'[]'), timeUsed:0, finished:false
};
poolSize.textContent = POEMS.length + " é¦–ï¼ˆè‡ªåŠ¨å‡ºé¢˜â‰¥300ï¼‰";

btnStart.onclick = startGame;
btnAgain.onclick = startGame;
btnRetry.onclick = startGame;

function startGame(){
  state.items = genQuestions();
  state.total = state.items.length;
  state.idx=0; state.score=0; state.finished=false; state.timeUsed=0;
  qTotal.textContent=state.total;
  prog.max = state.total; prog.value=0;
  scoreEl.textContent=0; qIndex.textContent=1;
  sumBox.style.display='none'; $('#review').style.display='none';
  btnAgain.style.display='none';
  qaBox.style.display='block';
  nextQ();
}

function nextQ(){
  if(state.timer){ clearInterval(state.timer); state.timer=null; }
  if(state.idx >= state.items.length){ return finish(); }
  const it = state.items[state.idx];
  qDiff.textContent = DIFF_LABEL[it.level];
  qText.textContent = it.stem;
  extra.textContent = it.extra || '';
  optsBox.innerHTML='';
  $('#hint').style.display='none'; $('#hint').textContent='';
  qIndex.textContent = state.idx+1;

  it.opts.forEach((o,i)=>{
    const div=document.createElement('div');
    div.className='opt'; div.tabIndex=0;
    div.innerHTML = `<b>${i+1}.</b> ${o}`;
    div.onclick = ()=> choose(o);
    optsBox.appendChild(div);
  });

  // è®¡æ—¶ï¼ˆå›ºå®š20sï¼‰
  state.tLeft = FIX_TIME; timeLeft.textContent = state.tLeft;
  state.timer = setInterval(()=>{
    state.tLeft--; state.timeUsed++;
    timeLeft.textContent = state.tLeft;
    if(state.tLeft<=0){ clearInterval(state.timer); state.timer=null; timeout(); }
  },1000);

  // å¿«æ·é”® 1-4
  document.onkeydown = (e)=>{
    const n = parseInt(e.key,10);
    if(n>=1 && n<=4 && it.opts[n-1]) choose(it.opts[n-1]);
  };

  function timeout(){ showResult(false); recordWrong(''); }
  function choose(val){
    if(state.timer){ clearInterval(state.timer); state.timer=null; }
    const ok = (val===it.answer);
    showResult(ok);
    if(!ok) recordWrong(val);
  }
  function showResult(ok){
    [...optsBox.children].forEach(c=>{
      const text = c.textContent.replace(/^\d+\.\s*/,'');
      if(text===it.answer) c.classList.add('correct');
      else c.classList.add('wrong');
      c.onclick=null;
    });
    if(ok){ state.score+=5; playOk(); } else { playNg(); }
    scoreEl.textContent = state.score;
    prog.value = state.idx+1;
    setTimeout(()=>{ state.idx++; nextQ(); }, 900);
  }
  function recordWrong(user){
    state.wrong.push({stem:it.stem, poem:it.poem, answer:it.answer, user});
    if(state.wrong.length>200) state.wrong = state.wrong.slice(-200);
    localStorage.setItem('poem_wrong', JSON.stringify(state.wrong));
  }
}

function finish(){
  qaBox.style.display='none'; btnAgain.style.display='inline-block';
  state.finished=true;
  const rightRate = Math.round(state.score / (state.items.length*5) * 100);
  sumText.innerHTML = `
    <div style="text-align:center;margin-top:6px">
      <div style="font-size:28px;color:var(--primary);font-weight:900">æœ¬è½®ç»“æŸ</div>
      <div class="muted">ç”¨æ—¶ <b>${state.timeUsed}</b> ç§’ï½œæ€»åˆ† <b>${state.score}</b>ï½œæ­£ç¡®ç‡ <b>${rightRate}%</b></div>
      <div class="hint" style="display:inline-block;margin-top:8px">ç»§ç»­é—¯å…³ï¼Œæˆ–æŠŠé”™é¢˜åŠ å…¥æ”¶è—æ…¢æ…¢å•ƒï¼</div>
    </div>`;
  sumBox.style.display='block';
}

/* é”™é¢˜æœ¬ */
function renderWrong(){
  wrongList.innerHTML='';
  if(state.wrong.length===0){ wrongList.innerHTML='<div class="board muted">æš‚æ— é”™é¢˜ï¼Œç»§ç»­ä¿æŒï¼</div>'; return; }
  state.wrong.slice(-40).reverse().forEach(w=>{
    const d = document.createElement('div');
    d.className='board';
    d.innerHTML = `<div class="small"><b>é¢˜å¹²ï¼š</b>${w.stem}</div>
                   <div class="small"><b>ä½ çš„ç­”æ¡ˆï¼š</b><span class="wrongx">${w.user||'ï¼ˆæ— ï¼‰'}</span></div>
                   <div class="small"><b>æ­£ç¡®ï¼š</b><span class="right">${w.answer}</span></div>
                   <div class="small muted">å‡ºè‡ªï¼šã€Š${w.poem.title}ã€‹Â·${w.poem.author}</div>`;
    wrongList.appendChild(d);
  });
}
btnClearWrong.onclick = ()=>{ state.wrong=[]; localStorage.setItem('poem_wrong','[]'); renderWrong(); }
btnReview.onclick = ()=>{ renderWrong(); $('#review').style.display='block'; }
btnCloseReview.onclick = ()=>{ $('#review').style.display='none'; }

/* æ’è¡Œæ¦œï¼ˆæœ¬æœºï¼‰ */
function loadRank(){ return JSON.parse(localStorage.getItem('poem_rank')||'[]'); }
function saveRank(list){ localStorage.setItem('poem_rank', JSON.stringify(list)); }
function renderRank(){
  const rk = loadRank().slice(0,10);
  const ol = $('#rank'); ol.innerHTML='';
  rk.forEach((r)=>{ const li=document.createElement('li'); li.textContent = `${r.date}ï½œ${r.score} åˆ†ï¼ˆç”¨æ—¶ ${r.time}sï¼‰`; ol.appendChild(li); });
}
renderRank();
$('#btnSaveRank').onclick = ()=>{
  if(!state.finished) return alert('è¯·å…ˆå®Œæˆä¸€è½®å†ä¿å­˜æˆç»©~');
  const rk = loadRank();
  rk.unshift({date:new Date().toLocaleString(), score:state.score, time:state.timeUsed});
  saveRank(rk.sort((a,b)=>b.score-a.score));
  renderRank();
}
$('#btnClearRank').onclick = ()=>{ localStorage.removeItem('poem_rank'); renderRank(); }

/* ========= å°ç”µè§†æ’­æ”¾å™¨ï¼ˆBç«™/é€šç”¨/æœ¬åœ° + éŸ³é¢‘emojiï¼‰ ========= */
const mediaInput = $('#mediaInput');
const mount = $('#playerMount');
const audioEmoji = $('#audioEmoji');

function isBV(str){ return /^BV[0-9A-Za-z]+$/.test(str.trim()); }
function parseBVfromUrl(url){
  const m = url.match(/\/BV([0-9A-Za-z]+)/i);
  return m ? "BV"+m[1] : null;
}
function isAudioUrl(u){ return /\.(mp3|flac|aac|m4a|ogg|wav)(\?.*)?$/i.test(u); }
function isVideoUrl(u){ return /\.(mp4|webm|ogg|mov|mkv)(\?.*)?$/i.test(u); }

function loadBV(bv){
  audioEmoji.style.display='none';
  mount.innerHTML = '';
  const iframe = document.createElement('iframe');
  iframe.src = `https://player.bilibili.com/player.html?bvid=${encodeURIComponent(bv)}&page=1&high_quality=1&autoplay=1`;
  iframe.allow = "autoplay; fullscreen; picture-in-picture";
  iframe.style.width='100%'; iframe.style.height='100%'; iframe.frameBorder='0';
  mount.appendChild(iframe);
}

function loadVideoUrl(url){
  mount.innerHTML='';
  const v = document.createElement('video');
  v.src = url; v.controls = true; v.autoplay = true; v.style.width='100%'; v.style.height='100%';
  mount.appendChild(v);
  audioEmoji.style.display = isAudioUrl(url) ? 'inline-block' : 'none';
}

$('#btnLoadUrl').onclick = ()=>{
  let val = mediaInput.value.trim();
  if(!val) return;
  // 1) çº¯ BV
  if(isBV(val)) return loadBV(val);
  // 2) Bç«™é“¾æ¥é‡Œæå– BV
  if(/bilibili\.com\/video\//i.test(val)){
    const bv = parseBVfromUrl(val);
    if(bv) return loadBV(bv);
  }
  // 3) å…¶ä»–ç›´é“¾ï¼šè§†é¢‘æˆ–éŸ³é¢‘
  loadVideoUrl(val);
};

// æœ¬åœ°æ–‡ä»¶
$('#btnLoadLocal').onclick = ()=>{
  const f = $('#filePicker').files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  if(f.type.startsWith('audio/')){
    // ç”¨ <audio> æ’­æ”¾ï¼Œå¹¶æ˜¾ç¤º ğŸµ
    mount.innerHTML='';
    const a = document.createElement('audio');
    a.src = url; a.controls = true; a.autoplay = true; a.style.width='100%';
    mount.appendChild(a);
    audioEmoji.style.display='inline-block';
  }else{
    audioEmoji.style.display='none';
    loadVideoUrl(url);
  }
};

// é¢„ç½®ä¸€ä¸ªæ¼”ç¤ºï¼šä½ å¯ä»¥æ¢æˆè‡ªå·±çš„
mediaInput.value = "BV1afgjzVEUG";

/* ===== åˆå§‹åŒ– ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // ä¸è‡ªåŠ¨æ’­æ”¾ï¼Œç­‰ç”¨æˆ·ç‚¹å‡»ä»¥é¿å…æµè§ˆå™¨ç­–ç•¥æ‹¦æˆª
});
</script>
</body>
</html>

